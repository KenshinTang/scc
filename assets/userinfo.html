<!DOCTYPE html>

<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1.0,user-scalable=no" name="viewport">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no,email=no,adress=no" />

    <title>个人信息</title>

    <link rel="stylesheet" href="css/g.css">
    <link rel="stylesheet" href="css/comm.css">

    <style>
        .cellContent {
            height: 50px;
        }

        .cellContent input {
            text-align: right;
            font-size: 15px;
            height: 30px;
        }

        .cellContent input:disabled {
            background: none;
        }

        .cellContent input[type=button] {
            /*color: #CCCCCC;*/
            background-color: white;
            margin-right: 5px;
        }

        .head {
            overflow: hidden;
            border-radius: 22.5px;
        }

        .head,
        .head>img {
            height: 45px;
            width: 45px;
        }

        .headCell {
            height: 70px;
        }

        .faceImg {
            border-radius: 50%;
            background-color: #E4E4E4;
        }

        body>footer {
            z-index: 90;
        }

        .disable {
            color: #CCCCCC !important;
        }


        #cityName {
            width: 50%;
        }

        .selectImg img[src=""] {

            opacity: 0;

        }
    </style>
</head>

<body>
    <header>
        <div class="navBar bottomShadow">
            <div class="navBackIcon" onclick="model.clear();Comm.close();"></div>
            <div class="navItem mr10" onclick="model.updataCustomer()">保存</div>
            <div class="navTitle">个人信息</div>
        </div>
    </header>
    <section class="bg_white">
        <div class="linebod"></div>

        <div class="paddl15 bg_white">
            <div class="cellContent headCell bottomBorder indicator">
                <div class="label f16 icon_pre icon_tx">更改头像</div>
                <div class="head" style="border-radius: 50%;">
                    <div id="faceImg" class="selectImg">
                        <img id="face" src="" name="face" width="45" height="45" />
                    </div>
                </div>
            </div>
        </div>

        <div id="content">

        </div>

    </section>

    <footer>
        <div class="bg_trans m10 br5 col_white center lh50 f18" onclick="model.outApp()">退出登录</div>
    </footer>


</body>

<script id="main" type="text/html">
    <div class="linebod"></div>

    <div class="paddl15 bg_white ">
        <div class="cellContent  bottomBorder ">
            <div class="label f16 icon_pre icon_name ">姓名</div>
            <input id="nickName" type="text" name="nickName" data-reg="nickName" maxlength="16" placeholder="请填写昵称"
                id="ac_id" value="" />
        </div>
    </div>

    <input id="cityId" type="text" name="cityId" class="hide" value="" />
    <div class="paddl15 bg_white">
        <div class="cellContent indicator bottomBorder ">
            <div class="label f16 icon_pre icon_se ">城市</div>
            <input id="cityName" type="button" name="cityName" placeholder="选择城市" onclick="model.showAddress()" />
        </div>
    </div>


    <div class="paddl15 bg_white">
        <div class="cellContent indicator bottomBorder" onclick="Comm.go('modifyBindTel.html');">
            <div class="label f16 icon_pre icon_phone ">联系电话</div>
            <div id="phone" name="phone" class="col_title col_sub disable" style="color:#000 !important;">
            </div>
        </div>
    </div>

    <div class="paddl15 bg_white" onclick="Comm.go('modifyLoginPsw.html');">
        <div class="cellContent indicator bottomBorder">
            <div class="label f16 icon_pre icon_phone ">修改登录密码</div>
        </div>
    </div>


    <div class="paddl15 bg_white" onclick="model.goFirstSettingPwd()">
        <div class="cellContent indicator bottomBorder ">
            <div id="pwdText" class="label f16 icon_pre icon_time ">设置支付密码</div>
        </div>
    </div>
</script>


<script src="js/g.js "></script>
<script src="js/z.js "></script>
<script src="js/comm.js"></script>
<script src="js/area.js"></script>
<script src="js/picker.min.js"></script>
<script src="inc/upimg/upload.js"></script>
<script src="js/art-template.js"></script>
<script src="js/api.js"></script>


<script>
    var o;
    var imgSaveUrl;

    function pageload() {
        $("#content").html(template('main'));
        var uploader = new imgUploader('face');
        uploader.success = function () {
            var cimgUrl = uploader.imgList.length > 0 ? uploader.imgList[0] : 'img/error.png';
            var imgUrl = Comm.OSS.getImgUrl(cimgUrl, 's');
            $('#face').attr('src', imgUrl);
            var o = {};
            imgSaveUrl = cimgUrl;
            o.face = cimgUrl;
            AJAX.POST('/api/customer/updateCustomer', o, function (a) {
                if (a.code == 1) {
                    Comm.message('保存成功');
                } else {
                    Comm.message('保存失败');
                }
            });
        };
        AJAX.GET('/api/customer/my', function (a) {
            var data = a.data;
            var customer = data;
            var x;
            o = data;
            if (a.code == 1) {
                for (x in data) {
                    if (x == 'face') {
                        if (data[x] != '') {
                            //imgUrl =data[x] ;
                            imgSaveUrl = data[x];
                            $('#' + x).attr('src', Comm.OSS.getImgUrl(data[x]), 's');
                        }
                    } else if (x == 'cityId') {
                        Area.init(function () {
                            $('#cityName').val(Area.getFullName(data[x]));
                        });
                    } else {
                        $('#' + x).html(data[x]);
                        $('#' + x).val(data[x]);
                    }
                }
            }
            Comm.db('customer', data);
            if (data.payPassword != 0) {
                $('#pwdText').text('修改支付密码');
            };
        });
    }
    var model = {
        showAddress: function () {
            Area.init(function () {
                areaPicker = new Areapicker("选择地区", function (obj, name, sid) {
                    $("#cityId").val(sid);
                    $("#cityName").val(name);
                });
                areaPicker.show();
            });
        },
        clear: function () {
            Comm.db('customer', null)
        },
        updataCustomer: function () {
            var o = Check.submit('POST');
            o.face = imgSaveUrl;
            if (o) {
                if (o.nickName.length > 11) {
                    Comm.message('用户名过长');
                    return;
                }
                AJAX.POST('/api/customer/updateCustomer', o, function (a) {
                    if (a.code == 1) {
                        Comm.message('保存成功');
                        setTimeout(function () {
                            Comm.close();
                        }, 300);
                    } else {
                        Comm.message('保存失败');
                    }
                });
            }
        },
        goFirstSettingPwd: function () {
            Comm.go('setOrModifyPayPsw.html');
        },
        outApp: function () {
            exitToken();
            signOut();
            Comm.goLogin();
        }
    }
</script>

</html>