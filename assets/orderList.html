<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1.0,user-scalable=no" name="viewport">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no,email=no,adress=no" />

    <title>订单</title>

    <link rel="stylesheet" href="css/g.css">
    <link rel="stylesheet" href="css/comm.css">
    <link rel="stylesheet" href="inc/mescroll/mescroll.min.css">

    <style>
        .page {
            display: none;
        }

        .segItem {
            color: #717171;
            line-height: 25px;
        }

        .segItem.active {
            color: #E30008;
            border-bottom: 2px solid #E30008;
        }

        .statuBar {
            height: 40px;
            line-height: 15px;
            box-sizing: unset;
        }

        .p15h {
            padding-left: 15px;
            padding-right: 15px;
        }

        .iconContain {
            width: 75px;
            height: 75px;
            border-radius: 3px;
            overflow: hidden;
        }

        .optionItem {
            color: #E30008;
            border: 1px solid #E30008;
            width: 80px;
            line-height: 30px;
            border-radius: 15px;
            text-align: center;
            margin-right: 10px;
        }

        .optionItem.unImp {
            color: #B3B3B3;
            border: 1px solid #E5E5E5;
        }
    </style>

</head>

<!--******************************************************************************-->

<body>

    <header>
        <div class="navBar bottomShadow">
            <div class="navBackIcon" onclick="Comm.close()"></div>
            <div class="navTitle">订单</div>
        </div>


        <div class="segBar flex_around pad_v10">
            <div class="segItem active">全部</div>
            <div class="segItem">待付款</div>
            <div class="segItem">待发货</div>
            <div class="segItem">待收货</div>
            <div class="segItem">已完成</div>
        </div>

    </header>
    <!--******************************************************************************-->

    <section class="bg_lgray">

        <div class="page mescroll" id="refreshId0">
            <div id="id_list0">

            </div>
        </div>


        <div class="page mescroll" id="refreshId1">
            <div id="id_list1">

            </div>
        </div>

        <div class="page mescroll" id="refreshId2">
            <div id="id_list2">

            </div>
        </div>

        <div class="page mescroll" id="refreshId3">
            <div id="id_list3">

            </div>
        </div>

        <div class="page mescroll" id="refreshId4">
            <div id="id_list4">

            </div>
        </div>


    </section>

    <!--******************************************************************************-->
    <footer></footer>

    <script src="js/z.js"></script>
    <script src="js/g.js"></script>
    <script src="js/comm.js"></script>
    <script src="js/api.js"></script>
    <script src="js/art-template.js"></script>
    <script src="inc/mescroll/mescroll.min.js"></script>
    <script src="js/dict.js"></script>



    <script>
        var curPageIdx = parseInt(Comm.query('type')) || 0;
        var sysTimeOutSecont;
        var pageRefArr = [],
            dataSourseDic = {};
        var recordNowTime = null,
            skipTime, timer = null;


        function pageload() {

            SLNetwork('get', '/api/sysconfig/getconfig', {
                keys: 'mall_orderPayout'
            }, function (data) {
                if (data.code == 1) {
                    nslog(data);
                    sysTimeOutSecont = data.data.mall_orderPayout * 60 * 1000 || 0;
                    showWithPageIndex(curPageIdx);
                    startTimer();
                } else {
                    Comm.message(data.msg);
                }
            });
        }


        function pageresume() {
            checkNeedRefreshPage(function (a) {
                if (a.type == 1) {
                    replaceOrderCell(a.oid);
                } else {
                    addrefresh(curPageIdx);
                }
            })
        }





        clickList('.segBar', '.segItem', function (o, idx) {
            showWithPageIndex(idx);
        });


        function showWithPageIndex(pageIndex) {
            curPageIdx = pageIndex;
            $('.page').removeClass('show');
            $($('.page')[pageIndex]).addClass('show');

            $('.segBar .segItem').removeClass('active');
            $($('.segBar .segItem')[pageIndex]).addClass('active');

            addrefresh(pageIndex);
        }


        function addrefresh(idx) {
            var merefresh = pageRefArr[idx];

            if (!merefresh) {
                merefresh = new MERefresh();

                merefresh.refreshOption.refreshUrl = '/api/shoppingMall/order/list';
                merefresh.refreshOption.noMoreSize = 10;

                var requestState = idx;
                switch (idx) {
                    case 0:
                        requestState = 20;
                        break;
                    case 4:
                        requestState = 5;
                        break;
                    default:
                        requestState = idx;
                        break;
                }


                merefresh.refreshOption.refreshParm = {
                    state: requestState //当前任务的taskId
                }

                //页面 <刷新> 的回调
                merefresh.refreshOption.refresh_cb = function (refresh, d) {
                    d.data = d.data || [];
                    if (d.data) {
                        refresh.successEndRef(d.data && d.data.length, d.totalCount);
                    }

                    if (d.code == 1) {
                        var list = d.data || [];
                        var html = getOrderList(list);
                        merefresh.appendHtml(html);
                    } else {
                        Comm.message(d.msg);
                    }
                };
                merefresh.configurationDone('refreshId' + idx, 'id_list' + idx);
                pageRefArr[idx] = merefresh;
            } else {
                merefresh.MeRefScroll.resetUpScroll();
                // merefresh.MeRefScroll.triggerDownScroll();
            }
        }


        //根据数据返回内容html
        function getOrderList(list) {
            list.forEach(function (a) {
                if (!a) return;
                var time = new Date(timeReplace(a.addTime)).getTime() + sysTimeOutSecont;
                recordNowTime = a.nowTime;
                skipTime = 0;
                a.limtTime = time / 1000;
                dataSourseDic[a.ordersId] = a;
            })

            var html = template('tp_id_orderCell', list);
            return html;
        }




        //订单操作
        function orderOption(type, oid, p, directlyDel) { //p-price
            if (event) event.stopPropagation();
            preventRepeadClickDeal(function () {
                {
                    if (type == 5) { //去支付
                        var orderModel = dataSourseDic[oid];
                        Comm.go('pay.html?type=order&oid=' + oid);
                    } else if (type == 6) { //查看物流
                        Comm.openUrlStr('https://www.kuaidi100.com/?from=openv');
                        // Comm.go('logisticDetail.html');
                    } else if (type == 7) {
                        Comm.go('invoice.html?oid=' + oid + '&p=' + p);
                    } else if (type == 8) {
                        Comm.go('orderGoodsEva.html?oid=' + oid);
                    } else if (type == 2 && !directlyDel) {
                        Comm.confirm('是否要删除该订单', function (choose) {
                            if (choose == 1) {
                                orderOption(type, oid, p, true);
                            }
                        });
                        return;
                    }
                    if (type >= 5 && type <= 8) {
                        return;
                    }
                }


                var parm = {
                    handleType: type, //1取消订单 2删除订单 3确认收货 4提醒发货
                    ordersId: oid
                }


                Comm.loading('正在处理...');
                SLNetwork('post', '/api/shoppingMall/order/handle', parm, function (data) {
                    Comm.loading();
                    if (data.code == 1) {
                        nslog(data);

                        if (type == 1) { //取消订单
                            Comm.message('已取消订单');
                        } else if (type == 2) { //删除订单
                            var sel = '#id_list' + curPageIdx + ' #cell_' + oid;
                            $(sel).remove();
                            Comm.message('删除订单成功');
                            return;
                        } else if (type == 3) { //确认收货
                            Comm.message('已确认收货');
                        } else if (type == 4) { //提醒发货
                            Comm.message('已提醒商家发货');
                            return;
                        }
                        replaceOrderCell(oid);
                    } else {
                        Comm.message(data.msg);
                    }
                });
            }, 1, 200)
        }



        function replaceOrderCell(orderId) {

            if (!orderId) return;
            var params = {
                orderId: orderId
            }
            SLNetwork('get', '/api/shoppingMall/order/detail', params, function (data) {
                if (data.code == 1) {
                    var orderCellModel = data.data || {};

                    orderCellModel.isSingle = true;
                    var sel = '#id_list' + curPageIdx + ' #cell_' + orderId;
                    var eleCell = $(sel);
                    var html = getOrderList([orderCellModel]);
                    eleCell.replaceWith(html);
                } else {
                    debugMessage(data.msg);
                }
            });
        }



        function startTimer() {

            clearInterval(timer);
            timer = null;

            timer = setInterval(function () {
                skipTime++;
                var limitArr = $('.limitTime');
                limitArr.forEach(function (ele) {
                    var limit = $(ele).attr('limit');
                    var oid = $(ele).attr('oid');
                    var otype = $(ele).attr('otype');

                    if (recordNowTime) {
                        recordNowTime = recordNowTime.replace(/-/g, "/").replace(/\.0/g, "")
                    }

                    var timeLimit = parseInt(limit) - new Date(recordNowTime).getTime() / 1000 -
                        skipTime;


                    if (timeLimit <= 0 && otype == 1) {

                        var params = {
                            ordersAfterSaleId: oid || '',
                            itemType: 1,
                        }
                        SLNetwork('post', '/api/ordersAfterSale/overTimeAgree', params, function (
                        data) {
                            if (data.code == 1) {
                                replaceOrderCell(oid);
                            }
                        });
                    }
                    $(ele).text(getLimitText(timeLimit));
                });
            }, 1000);
        }


        function getLimitText(times) {
            var day = 0,
                hour = 0,
                minute = 0,
                second = 0; //时间默认值
            if (times > 0) {
                day = Math.floor(times / (60 * 60 * 24));
                hour = Math.floor(times / (60 * 60)) - (day * 24);
                minute = Math.floor(times / 60) - (day * 24 * 60) - (hour * 60);
                second = Math.floor(times) - (day * 24 * 60 * 60) - (hour * 60 * 60) - (minute * 60);
            } else {
                return '';
            }
            if (day <= 9) day = '0' + day;
            if (hour <= 9) hour = '0' + hour;
            if (minute <= 9) minute = '0' + minute;
            if (second <= 9) second = '0' + second;
            //

            var text = (minute + ":" + second);

            return '剩余' + text;
        }
    </script>


    <script>
        // 1:待付款
        // 2:待发货
        // 3:待收货
        // 4:已收货
        // 5:已完成
        // 10:已取消
        // 20:全部
    </script>

    <script type="text/html" id="tp_id_orderCell">
        {{each $data as model i}}

        <div class="orderCell mt10 {{isSingle?'border':''}}" id="cell_{{model.ordersId}}"
            onclick="Comm.go('orderDetail.html?oid={{model.ordersId}}')">

            <div class="flex_between bg_white p15h statuBar">
                <div>下单时间:{{formatDate(model.addTime,'Y-m-d H:i')}}</div>
                <div class="col_red tright">
                    <div class="statu f16">{{getState(model.state)}}</div>
                    {{if model.state == 1}}
                    <div class="limitTime f12" oid="{{model.ordersId}}" otype="{{model.state}}"
                        limit="{{model.limtTime}}"></div>
                    {{/if}}
                </div>
            </div>


            <!--商品信息-->
            <div class="bg_lgray p15">
                <div class="flex f16 pad10">
                    <div class="br3 iconContain imgContain">
                        <img src="{{OSS(model.faceImg,'s')}}" onerror="app.errorimg(this);">
                    </div>

                    <div class="column paddl10 grow1" style="min-height: 75px;width:100%;">

                        <div class="flex_between">
                            <div class="f15 lh20 wordW2">{{model.goodsName}}</div>
                            <div class="coloreb3 f12 endTest w50">¥{{priceTp(model.price)}}</div>
                        </div>

                        <div class=" f12 autoW edit_model mt10 flex_between">
                            <div class="baseWH col_sub">{{model.specText||''}}</div>
                            <div class="w50 tright color999 f16">x{{model.goodsCount||1}}</div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="flex_between bg_white p15h statuBar pad_v5 bottomBorder">
                <div></div>
                <div class="flex_start">
                    <div class="col_sub">合计:</div>
                    <div class="bold f18">¥{{priceTp(model.totalMoney)}}</div>
                    {{if model.freight}}
                    <!-- <div class="col_sub">(含运费¥{{priceTp(model.freight)}})</div> -->
                    {{/if}}
                </div>
            </div>

            <div class="flex_between pad_v10 bg_white">
                <div></div>
                <div class="flex_wrap optionBar">

                    {{if model.state == 1}}
                    <div class="optionItem unImp" onclick="orderOption(1,'{{model.ordersId}}')">取消订单</div>
                    <div class="optionItem" onclick="orderOption(5,'{{model.ordersId}}')">去付款</div>
                    {{else if model.state == 2}}
                    <div class="optionItem" onclick="orderOption(4,'{{model.ordersId}}')">提醒发货</div>
                    {{else if model.state == 3}}
                    <div class="optionItem unImp" onclick="orderOption(6,'{{model.ordersId}}')">查看物流</div>
                    <div class="optionItem" onclick="orderOption(3,'{{model.ordersId}}')">确认收货</div>
                    {{else if model.state == 4||model.state == 5}}
                    <!--已完成、已收货-->


                    {{if model.invoice == 1}}
                    {{if (model.invoiceState !== 0 && !model.invoiceState) || model.invoiceState == 2}}

                    {{if(!model.type || model.type!=1)}}
                    <div class="optionItem unImp" onclick="orderOption(7,'{{model.ordersId}}','{{model.price}}')">申请开票
                    </div>
                    {{/if}}
                    {{/if}}
                    {{/if}}


                    {{if !model.evaluateState || model.evaluateState == 0}}
                    <div class="optionItem" onclick="orderOption(8,'{{model.ordersId}}')">评价</div>
                    {{/if}}


                    {{else if model.state == 10 || model.state == 5}}
                    <div class="optionItem unImp" onclick="orderOption(2,'{{model.ordersId}}')">删除订单</div>
                    {{/if}}

                </div>
            </div>
        </div>

        {{/each}}
    </script>


</body>

</html>